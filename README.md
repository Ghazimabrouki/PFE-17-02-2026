# Complete SOC Platform — Automated Setup (All-in-One SIEM + Detection + Observability)**Author & Maintainer:** Ghazi Mabrouki  **Version:** 2.0A complete **Security Operations Center (SOC)** platform that automates deployment of enterprise-grade monitoring tools on **a single machine**.  All components integrate with **Elasticsearch** for centralized search, correlation, and visualization via **Kibana**.> ✅ Goal: one command to deploy a complete SOC stack for labs, PoCs, demos, training, and security validation.---## Table of Contents- [What You Get](#what-you-get)- [Architecture](#architecture)- [Components](#components)  - [1) SIEM Stack (Elasticsearch + Kibana + Filebeat)](#1-siem-stack-elasticsearch--kibana--filebeat)  - [2) Suricata (Network IDS/IPS)](#2-suricata-network-idsips)  - [3) Wazuh Manager (Host IDS)](#3-wazuh-manager-host-ids)  - [4) Falco + Falcosidekick (Runtime Security)](#4-falco--falcosidekick-runtime-security)  - [5) OpenTelemetry Collector (Observability)](#5-opentelemetry-collector-observability)  - [6) Metricbeat (Infrastructure & Prometheus Metrics)](#6-metricbeat-infrastructure--prometheus-metrics)- [Requirements](#requirements)- [Quick Start](#quick-start)- [Installation Order](#installation-order)- [Access & Verification](#access--verification)- [Data Flow](#data-flow)- [Network Ports](#network-ports)- [Index Patterns & Indices](#index-patterns--indices)- [Metricbeat Setup (Optional / Recommended)](#metricbeat-setup-optional--recommended)- [Testing & Validation](#testing--validation)- [Troubleshooting](#troubleshooting)- [Security Best Practices](#security-best-practices)- [Maintenance](#maintenance)- [Uninstallation](#uninstallation)- [OpenSearch Support (Patched)](#opensearch-support-patched)- [License](#license)- [Credits](#credits)---## What You GetThis project deploys and integrates:- **SIEM Core:** Elasticsearch + Kibana + Filebeat  - **Network Detection:** Suricata (NIDS)  - **Host Detection:** Wazuh Manager (HIDS)  - **Runtime Detection:** Falco + Falcosidekick  - **Observability:** OpenTelemetry Collector (logs / metrics / traces)  - **Metrics Shipping (Optional/Recommended):** Metricbeat (System + Prometheus metrics)All data lands in Elasticsearch with dedicated index patterns for fast investigation in Kibana.---## Architecture```┌─────────────────────────────────────────────────────────────────────────┐│                         Data Collection Layer                            │├─────────────────────────────────────────────────────────────────────────┤│  Suricata  │  Wazuh    │  Falco    │  OpenTelemetry  │    Metricbeat     ││  (Network) │  (Host)   │ (Runtime) │ (Observability) │ (System/Prometheus)│└──────┬──────────┬───────────┬────────────┬───────────────┬───────────────┘       │          │           │            │               │       │          │      ┌────▼────┐       │               │       │          │      │ Sidekick│       │               │       │          │      └────┬────┘       │               │       └──────────┴───────────┴────────────┴───────────────┴───────────────┐                                                                             │                                  ┌──────────────────────────────────────────▼─┐                                  │               Elasticsearch                 │                                  │                 (SIEM Core)                 │                                  └──────────────────────────┬──────────────────┘                                                             │                                  ┌──────────────────────────▼──────────────────┐                                  │                    Kibana                   │                                  │              (Visualization / UI)           │                                  └─────────────────────────────────────────────┘```---# Detailed Project Diagram (Services, Interactions, and Log Transit)This document maps the full platform described by this repository, including setup orchestration, runtime service interactions, and telemetry/log paths into Elasticsearch/OpenSearch-compatible backends.## 1) End-to-End Service Topology```mermaidflowchart TB  %% ==============================  %% HOST / ORCHESTRATION  %% ==============================  subgraph HOST["Host Machine (Ubuntu) - Single-node SOC deployment"]    subgraph ORCH["Installer / Orchestration Layer"]      SETUP["setup_script.sh\n- root/prereq checks\n- prompts install order\n- invokes component scripts"]      SIEM_SCRIPT["siem_setup.sh"]      SURI_SCRIPT["suricata_setup.sh"]      WAZUH_SCRIPT["wazuh_setup.sh"]      FALCO_SCRIPT["falco_setup.sh"]      OTEL_SCRIPT["otel_setup.sh"]      MB_SCRIPT["machine_metrics_setup.sh"]      SETUP --> SIEM_SCRIPT      SETUP --> SURI_SCRIPT      SETUP --> WAZUH_SCRIPT      SETUP --> FALCO_SCRIPT      SETUP --> OTEL_SCRIPT      SETUP --> MB_SCRIPT    end    subgraph SIEM["SIEM Core (systemd services)"]      ES["Elasticsearch 7.17.13\nPort 9200/TLS\nIndex/Search backend"]      KB["Kibana 7.17.13\nPort 5601/TLS\nVisualization/UI"]      FB["Filebeat\nShipper + modules"]      CERTS["Self-signed cert generation\nCA + node certs\nused by ES/Kibana/Filebeat"]      CERTS --> ES      CERTS --> KB      CERTS --> FB      KB <-->|"API + auth"| ES      FB -->|"output.elasticsearch (TLS/auth)"| ES    end    subgraph NETSEC["Network Security Layer"]      SURI["Suricata NIDS\nLocal interface capture\nEVE JSON output"]      SURI_LOG["/var/log/suricata/eve.json"]      SURI --> SURI_LOG    end    subgraph HOSTSEC["Host Security Layer"]      WAZUH["Wazuh Manager 4.5.4\nPorts 1514/1515 TCP\nFIM/Vuln/Compliance/Active response"]      AGENTS["Wazuh agents (external hosts)"]      AGENTS -->|"register 1515 / events 1514"| WAZUH    end    subgraph RUNTIMESEC["Runtime Security Layer (Docker)"]      FALCO["Falco container\nKernel/eBPF syscall detection\njson_output + http_output"]      FSK["Falcosidekick container\nPort 2801\nEvent forwarder"]      FALCO -->|"HTTP events"| FSK      FSK -->|"ELASTICSEARCH_* env\nindex: falco-events"| ES    end    subgraph OBS["Observability Layer (Docker)"]      OTEL["OpenTelemetry Collector\notel/opentelemetry-collector-contrib:0.91.0\nnetwork_mode: host"]      APPS["OTLP clients/apps/services\n(any telemetry source)"]      APPS -->|"OTLP gRPC :4317"| OTEL      APPS -->|"OTLP HTTP :4318"| OTEL      OTEL -->|"elasticsearch/logs exporter\nlogs_index=otel-logs"| ES      OTEL -->|"elasticsearch/traces exporter\ntraces_index=otel-traces"| ES      OTEL_H["Health :13133"]      OTEL_M["Prometheus :8888/metrics"]      OTEL_Z["zPages :55679"]      OTEL --> OTEL_H      OTEL --> OTEL_M      OTEL --> OTEL_Z    end    subgraph METRICS["Infrastructure Metrics (systemd)"]      MB["Metricbeat 7.17.13\nSystem module + optional Prometheus module"]      MB -->|"metricbeat-*"| ES      MB -->|"setup.kibana"| KB      OTEL_M -->|"scraped by Metricbeat prometheus module"| MB    end    SURI_LOG -->|"Filebeat suricata module"| FB    WAZUH -->|"Filebeat wazuh module\nalerts/archive streams"| FB    USER["SOC analyst / operator"]    USER -->|"HTTPS :5601"| KB    USER -->|"API queries"| ES  end  %% ==============================  %% OPTIONAL/SEPARATE AI STACK  %% ==============================  subgraph AI["Separate docker-compose stack (docker-compose.yml)"]    OLLAMA["ollama container\nPort 11434"]    DS["deepseek-setup init container\npulls deepseek-r1:14b"]    WEBUI["open-webui container\nHost port 3000 -> container 8080"]    DS --> OLLAMA    WEBUI -->|"OLLAMA_BASE_URL"| OLLAMA  end```## 2) Detailed Log/Telemetry Transit Paths```mermaidflowchart LR  %% Suricata pipeline  SURI_EVT["Suricata EVE events\n/var/log/suricata/eve.json"] --> FB_SURI["Filebeat suricata module\nmodules.d/suricata.yml"]  FB_SURI --> ES_FILEBEAT["Elasticsearch index family\nfilebeat-*"]  %% Wazuh pipeline  WAZUH_ALERT["Wazuh manager alerts"] --> FB_WAZUH["Filebeat wazuh module\n+wazuh-template.json"]  FB_WAZUH --> ES_WAZUH["Elasticsearch index family\nwazuh-alerts-*"]  %% Falco pipeline  FALCO_EVT["Falco syscall/rule events\njson_output + http_output"] --> FSK_IN["Falcosidekick :2801"]  FSK_IN --> ES_FALCO["Elasticsearch index family\nfalco-events-*"]  %% OTel pipeline  OTLP_IN_G["OTLP gRPC :4317"] --> OTEL_PIPE["OTel pipelines\nreceivers: otlp\nprocessor: batch"]  OTLP_IN_H["OTLP HTTP :4318"] --> OTEL_PIPE  OTEL_PIPE --> ES_OTEL_LOGS["Elasticsearch index family\notel-logs-*"]  OTEL_PIPE --> ES_OTEL_TRACES["Elasticsearch index family\notel-traces-*"]  %% Metricbeat pipeline  HOST_MET["Host metrics\nCPU/RAM/Disk/Network/Processes"] --> MB_SYS["Metricbeat system module"]  OTEL_PROM["OTel /metrics :8888"] --> MB_PROM["Metricbeat prometheus module"]  MB_SYS --> MB_OUT["Metricbeat output.elasticsearch"]  MB_PROM --> MB_OUT  MB_OUT --> ES_MB["Elasticsearch index family\nmetricbeat-*"]  %% Search/visualization sink  ES_FILEBEAT --> KIBANA["Kibana Discover/Dashboards"]  ES_WAZUH --> KIBANA  ES_FALCO --> KIBANA  ES_OTEL_LOGS --> KIBANA  ES_OTEL_TRACES --> KIBANA  ES_MB --> KIBANA```## 3) Control-Plane and Credential/Config Dependency Flow```mermaidflowchart TD  SIEM_CFG["siem_setup.sh creates /etc/filebeat/filebeat.yml\nwith output.elasticsearch hosts/user/password\nand setup.kibana host"]  FALCO_PARSE["falco_setup.sh parses /etc/filebeat/filebeat.yml\n(if OPENSEARCH_* env not set)"]  OTEL_PARSE["otel_setup.sh parses /etc/filebeat/filebeat.yml\n(if OPENSEARCH_* env not set)"]  MB_PARSE["machine_metrics_setup.sh parses /etc/filebeat/filebeat.yml\nfor ES/Kibana endpoints + creds"]  SIEM_CFG --> FALCO_PARSE  SIEM_CFG --> OTEL_PARSE  SIEM_CFG --> MB_PARSE  ENV_OVERRIDE["Optional env override:\nOPENSEARCH_URL / OPENSEARCH_USERNAME / OPENSEARCH_PASSWORD"] --> FALCO_PARSE  ENV_OVERRIDE --> OTEL_PARSE  FALCO_PARSE --> FALCO_DEPLOY["/opt/falco/docker-compose.yml\nELASTICSEARCH_* env for Falcosidekick"]  OTEL_PARSE --> OTEL_DEPLOY["/opt/otel/.env + otel-collector-config.yaml\nelasticsearch exporters"]  MB_PARSE --> MB_CFG["/etc/metricbeat/metricbeat.yml\noutput.elasticsearch + setup.kibana"]```## 4) Installation/Startup Dependency Graph```mermaidflowchart LR  A["1. SIEM setup\n(Elasticsearch + Kibana + Filebeat)"] --> B["2. Suricata setup\n(Filebeat suricata module)"]  A --> C["3. Wazuh setup\n(Filebeat wazuh module + Kibana plugin)"]  A --> D["4. Falco setup\n(needs backend creds)"]  A --> E["5. OpenTelemetry setup\n(needs backend creds)"]  A --> F["6. Metricbeat setup\n(reuses Filebeat backend config)"]```## 5) Port-Level Interaction Map```mermaidflowchart TB  ES9200["Elasticsearch :9200 HTTPS"]  KB5601["Kibana :5601 HTTPS"]  W1514["Wazuh :1514 TCP"]  W1515["Wazuh :1515 TCP"]  F2801["Falcosidekick :2801 HTTP"]  O4317["OTel OTLP gRPC :4317"]  O4318["OTel OTLP HTTP :4318"]  O13133["OTel Health :13133"]  O8888["OTel Metrics :8888"]  O55679["OTel zPages :55679"]  OLLAMA11434["Ollama :11434"]  WEBUI3000["Open-WebUI :3000 -> 8080"]  Filebeat["Filebeat"] --> ES9200  Kibana["Kibana server"] --> ES9200  Analyst["Browser/Operator"] --> KB5601  Agents["Wazuh agents"] --> W1515  Agents --> W1514  Falco["Falco"] --> F2801  Falcosidekick["Falcosidekick"] --> ES9200  OTLPClients["Telemetry clients"] --> O4317  OTLPClients --> O4318  Metricbeat["Metricbeat prometheus module"] --> O8888  OTEL["OTel Collector"] --> O13133  OTEL --> O55679  OTEL --> ES9200  WebUI["Open-WebUI"] --> OLLAMA11434  UserAI["AI UI user"] --> WEBUI3000```## Components### 1) SIEM Stack (Elasticsearch + Kibana + Filebeat)- Elasticsearch **7.17.13** (core storage/search)- Kibana **7.17.13** (dashboards + investigation)- Filebeat (log shipper)**Features**- Centralized log management- Real-time search and analytics- TLS/SSL support- Authentication & access control---### 2) Suricata (Network IDS/IPS)High-performance network IDS with deep protocol inspection and signatures.**Integration**- Events: `/var/log/suricata/eve.json`- Shipped via Filebeat to Elasticsearch (`filebeat-*`)- Designed for Kibana dashboards> Note: Suricata monitors the local interface. To monitor full network traffic, feed it via **TAP/SPAN**.---### 3) Wazuh Manager (Host IDS)Wazuh Manager **4.5** provides:- FIM (File Integrity Monitoring)- Vulnerability detection- Configuration assessment / compliance (PCI DSS, GDPR, HIPAA)- Active response**Integration**- Alerts indexed into Elasticsearch (`wazuh-alerts-*`)- Visualized in Kibana (Wazuh app/plugin when applicable)---### 4) Falco + Falcosidekick (Runtime Security)- Falco monitors kernel/system calls (eBPF)- Falcosidekick forwards Falco events to Elasticsearch**Integration**- Falco → Falcosidekick → Elasticsearch (`falco-events-*`)- Optional backup log: `/var/log/falco/events.json`**Examples of detections**- Sensitive file reads (`/etc/shadow`, `/etc/sudoers`)- Privilege escalation patterns- Reverse shells- Package manager execution- Crypto-mining behavior---### 5) OpenTelemetry Collector (Observability)- OTLP ingestion (gRPC/HTTP)- Metrics + logs + traces- Prometheus scrape endpoint- Exports to Elasticsearch indices:  - `otel-logs-*`  - `otel-metrics-*`  - `otel-traces-*`**Useful endpoints**- Health: `http://localhost:13133`- Prometheus metrics: `http://localhost:8888/metrics`---### 6) Metricbeat (Infrastructure & Prometheus Metrics)Metricbeat is the Elastic-native agent for **system metrics** and **Prometheus-style metrics** ingestion. It complements the platform by providing:- Host system metrics (CPU/RAM/Disk/Network)- Service metrics- Prometheus endpoint scraping (e.g., scraping OpenTelemetry Collector `/metrics`)**Integration**- Metricbeat → Elasticsearch (`metricbeat-*`)> If you already rely fully on OpenTelemetry for metrics, Metricbeat can remain optional.  > For many SOC lab setups, Metricbeat is still very useful for quick host visibility + Prometheus scraping.---## Requirements### Minimum (Lab)- Ubuntu **20.04+** (18.04 supported if scripts allow)- RAM: **8 GB** (16 GB recommended)- Disk: **50 GB** (100 GB recommended)- CPU: **4 cores** (8 cores recommended)- Internet connectivity### Recommended resources per component| Component | RAM | Disk | CPU ||---|---:|---:|---:|| Elasticsearch + Kibana | 4GB | 20GB | 2 cores || Suricata | 2GB | 5GB | 2 cores || Wazuh | 2GB | 10GB | 1 core || Falco + Sidekick | 1GB | 5GB | 1 core || OpenTelemetry | 1GB | 10GB | 1 core || Metricbeat | 256MB–512MB | <1GB | low |---## Quick Start```bashgit clone https://github.com/Ghazimabrouki/PFE-17-02-2026/cd PFE-17-02-2026chmod +x *.shsudo ./setup_script.sh```---## Installation OrderThe platform is installed in dependency order:1. **SIEM** (foundation: Elasticsearch/Kibana/Filebeat)2. **Suricata** (network telemetry)3. **Wazuh** (host security)4. **Falco + Falcosidekick** (runtime security)5. **OpenTelemetry** (observability)6. **Metricbeat** (system + Prometheus metrics) *(optional/recommended)*### Run a single component```bashsudo ./siem_setup.shsudo ./suricata_setup.shsudo ./wazuh_setup.shsudo ./falco_setup.shsudo ./otel_setup.shsudo ./metricbeat_setup.sh```---## Access & Verification### Kibana```bashhostname -I# Open: https://YOUR_SERVER_IP:5601```### Quick service status```bashfor svc in elasticsearch kibana filebeat suricata wazuh-manager falco-modern-bpf falcosidekick otelcol-contrib metricbeat; do  systemctl is-active --quiet $svc && echo "✓ $svc" || echo "✗ $svc"done```### Check Elasticsearch indices```bashcurl -k -u elastic:PASSWORD "https://localhost:9200/_cat/indices?v"```---## Data Flow- **Suricata → Filebeat → Elasticsearch**  - `/var/log/suricata/eve.json → filebeat-*`- **Wazuh → Elasticsearch**  - `wazuh-alerts-*`- **Falco → Falcosidekick → Elasticsearch**  - `falco-events-*`- **OpenTelemetry → Elasticsearch**  - `otel-logs-*`, `otel-metrics-*`, `otel-traces-*`- **Metricbeat → Elasticsearch**  - `metricbeat-*`  - Optional: Metricbeat Prometheus module scraping `http://localhost:8888/metrics`---## Network Ports| Service | Port | Protocol | Purpose ||---|---:|---|---|| Elasticsearch | 9200 | HTTPS | REST API || Kibana | 5601 | HTTPS | Web UI || Wazuh Manager | 1514 | TCP | Agent communication || Wazuh Manager | 1515 | TCP | Agent registration || Falcosidekick | 2801 | HTTP | Falco event receiver || Falco Webserver | 8765 | HTTP | Metrics/Health || OTLP gRPC | 4317 | gRPC | Telemetry || OTLP HTTP | 4318 | HTTP | Telemetry || OTel Health | 13133 | HTTP | Health check || OTel Metrics | 8888 | HTTP | Prometheus metrics || OTel zPages | 55679 | HTTP | Debug || Metricbeat | — | — | Agent (ships metrics to ES) |---## Index Patterns & Indices**Indices**- `filebeat-*` → system logs + Suricata events- `wazuh-alerts-*` → Wazuh alerts- `falco-events-*` → Falco runtime security events- `otel-logs-*` / `otel-metrics-*` / `otel-traces-*` → OpenTelemetry exports- `metricbeat-*` → host metrics + Prometheus-scraped metrics (optional)**Kibana Discover filters**- Suricata: `event.dataset: suricata.eve`- Wazuh: `agent.type: wazuh`- Falco: index `falco-events-*`- OTel: index `otel-*`- Metricbeat: index `metricbeat-*`---## Metricbeat Setup (Optional / Recommended)Install Metricbeat (Elastic 7.17.13, Ubuntu DEB):```bashcurl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.17.13-amd64.debsudo dpkg -i metricbeat-7.17.13-amd64.deb```### Configure output to ElasticsearchEdit: `/etc/metricbeat/metricbeat.yml````yamloutput.elasticsearch:  hosts: ["https://localhost:9200"]  username: "elastic"  password: "PASSWORD"  ssl.verification_mode: none```### Enable modules```bashsudo metricbeat modules enable systemsudo metricbeat modules enable prometheus```### Prometheus scraping (example: scrape OTel Collector metrics)Edit: `/etc/metricbeat/modules.d/prometheus.yml````yaml- module: prometheus  period: 10s  hosts: ["localhost:8888"]  metrics_path: /metrics```### Start Metricbeat```bashsudo systemctl enable metricbeatsudo systemctl start metricbeatsudo systemctl status metricbeat --no-pager```---## Testing & Validation### Test Falco detections```bashsudo cat /etc/shadowsudo apt-get updatetail -f /var/log/falco/events.json```### Query Falco events in Elasticsearch```bashcurl -k -u elastic:PASSWORD "https://localhost:9200/falco-events-*/_search?pretty"```### Test OpenTelemetry```bashcurl http://localhost:13133curl http://localhost:8888/metrics```### Test Metricbeat```bashcurl -k -u elastic:PASSWORD "https://localhost:9200/metricbeat-*/_search?pretty"```---## Troubleshooting### Service not starting```bashsystemctl status SERVICE_NAMEjournalctl -u SERVICE_NAME -n 100 --no-pager```### Validate configs```bash# OpenTelemetry/usr/local/bin/otelcol-contrib --config=/etc/otelcol-contrib/config.yaml validate# Filebeatfilebeat test configfilebeat test output```### No data in Kibana```bashcurl -k -u elastic:PASSWORD "https://localhost:9200/_cat/indices?v"systemctl restart filebeat```### High resource usage (Elasticsearch heap)Edit: `/etc/elasticsearch/jvm.options`  Set (example):```-Xms2g-Xmx2g```Restart:```bashsystemctl restart elasticsearch```---## Security Best Practices- Change default passwords immediately (especially `elastic`)- Restrict Kibana access (IP allowlist / VPN only)- Enable firewall (example)  ```bash  ufw allow from TRUSTED_IP to any port 5601 proto tcp  ufw enable  ```- Replace self-signed certs with real certificates in production- Define retention (ILM policies) for all indices- Take regular snapshots/backups---## Maintenance### Daily```bash# optional if included in repo./health_check.sh```### Weekly```bashsuricata-updatesystemctl reload suricatadf -h```### Monthly```bashapt-get update && apt-get upgrade -y```---## Uninstallation> This removes components and deletes related configuration/log folders. Use with caution.```bashsystemctl stop elasticsearch kibana filebeat suricata wazuh-manager falco-modern-bpf falcosidekick otelcol-contrib metricbeatapt-get purge elasticsearch kibana filebeat suricata wazuh-manager falco metricbeat -yrm -rf   /etc/elasticsearch /etc/kibana /etc/filebeat /etc/suricata   /etc/falco /etc/falcosidekick /etc/otelcol-contrib   /etc/metricbeat /var/lib/metricbeat   /var/ossec /var/log/falco /var/log/otelcol```---## OpenSearch Support (Patched)Falco and OpenTelemetry scripts can send data to **OpenSearch** (or Elasticsearch-compatible endpoints).  Override the backend without touching Filebeat:```bashexport OPENSEARCH_URL="https://10.0.0.10:9200"export OPENSEARCH_USERNAME="admin"export OPENSEARCH_PASSWORD="your_password"```If not set, scripts attempt to parse:  `/etc/filebeat/filebeat.yml` (`output.elasticsearch.*`).---## LicenseSee `LICENSE`.---## Credits- Elasticsearch & Kibana — Elastic NV- Suricata — Open Information Security Foundation (OISF)- Wazuh — Wazuh, Inc.- Falco — The Falco Project (CNCF)- Falcosidekick — Falco Security- OpenTelemetry — OpenTelemetry Project (CNCF)---## About the Author**Ghazi Mabrouki** — SOC Platform Developer  This platform was designed to provide an automated, unified monitoring and security detection stack for organizations and labs.
